# 屏幕關閉播放測試指南
# Screen-Off Playback Test Guide

## 🎯 本次修復內容

已經修復了屏幕關閉後無法持續播放的問題。

### 修改的文件

1. **App.tsx** - 添加應用層級的 KeepAwake 支持
2. **AudioPlayerService.ts** - 優化音頻中斷模式
3. **新增文檔** - SCREEN_OFF_PLAYBACK_FIX_V2.md

## ⚡ 快速測試步驟

### 測試 1: 屏幕關閉播放 ⭐ 最重要

```bash
1. 打開應用，播放任意電台
2. 按下電源鍵（關閉屏幕）
3. 等待 10 秒
   ✅ 音訊應該繼續播放
4. 再次按下電源鍵（打開屏幕）
   ✅ 應用狀態應該正常
   ✅ 播放應該繼續
```

### 測試 2: 後台播放

```bash
1. 播放電台
2. 按 Home 鍵（進入後台）
   ✅ 音訊繼續播放
3. 關閉屏幕
   ✅ 音訊繼續播放
4. 等待 30 秒
   ✅ 音訊仍在播放
5. 打開屏幕，回到應用
   ✅ 狀態正常同步
```

### 測試 3: 停止功能

```bash
1. 播放電台
2. 關閉屏幕
3. 打開屏幕
4. 點擊「停止」按鈕
   ✅ 播放應該停止
   ✅ 通知應該消失
```

## 📱 如果還是不能播放

### Android 品牌特殊設定

某些 Android 品牌（小米、華為、OPPO 等）有嚴格的電池管理，需要手動設定：

#### 小米 MIUI
```
設定 → 應用設定 → 應用管理 → mesonRadio
→ 省電策略 → 無限制
→ 自啟動 → 允許
→ 後台彈窗 → 允許
```

#### 華為 EMUI
```
設定 → 電池 → 應用啟動管理 → mesonRadio
→ 手動管理
→ 開啟「自動啟動」「後台活動」「螢幕鎖定後繼續執行」
```

#### OPPO ColorOS
```
設定 → 電池 → 應用耗電管理 → mesonRadio
→ 允許後台運行
設定 → 應用管理 → 應用列表 → mesonRadio
→ 權限 → 自啟動 → 允許
```

#### 原生 Android
```
設定 → 應用程式 → mesonRadio
→ 電池 → 不受限制
設定 → 電池 → 電池優化 → mesonRadio → 不優化
```

## 🔍 檢查日誌

重新編譯並運行應用後，應該看到以下日誌：

### 啟動時
```
✅ 音訊模式已配置（後台播放、屏幕關閉播放）
✅ 媒體通知服務初始化成功
✅ 後台任務服務初始化成功
✅ 音訊系統初始化成功（含後台支持）
```

### 播放時
```
✅ 流媒體播放成功
✅ Keep Awake 已激活（屏幕關閉時繼續播放）
🏥 健康檢查已啟動
```

### 屏幕狀態變化時
```
📱 App State changed: background  (進入後台)
📱 App State changed: active      (返回前台)
```

### 停止時
```
🛑 User stopped playback
✅ Keep Awake 已停用
🏥 健康檢查已停止
✅ 播放已停止
```

## 🔧 如何重新編譯

```bash
cd /home/meson/Meson/mesonRadio

# 清理緩存（可選）
npm run clean  # 如果有這個腳本
rm -rf node_modules/.cache

# 重新安裝依賴（可選，如果有問題）
npm install

# 編譯並運行
npm run android
```

## 📝 技術說明

### 雙重 KeepAwake 保護

1. **組件層級** (App.tsx):
   ```tsx
   {isPlaying && <KeepAwake />}
   ```
   - 當播放時自動激活
   - 應用層級保護
   
2. **API 層級** (AudioPlayerService.ts):
   ```typescript
   await activateKeepAwakeAsync('audio-playback');
   ```
   - 服務層級保護
   - 更精確的控制

### 音頻中斷模式

改用 `DuckOthers` 模式：
- ✅ 更穩定的後台播放
- ✅ 降低（而非暫停）其他音頻
- ✅ 與系統更友好

### AppState 監聽

實時追蹤應用狀態：
- `active` - 前台運行
- `background` - 後台運行
- `inactive` - 過渡狀態

## ❓ 常見問題

### Q1: 為什麼還是會停止播放？
A: 檢查手機的電池優化設定，某些品牌需要手動允許後台運行。

### Q2: 通知欄沒有顯示？
A: 檢查通知權限是否已允許。

### Q3: 網路斷線後無法自動重連？
A: 這是正常的重試機制，會在 5 秒後自動重試，最多重試 5 次。

### Q4: 音質不好？
A: 這取決於電台的串流品質，不是 APP 的問題。

## 📞 如果問題仍未解決

請提供以下資訊：
1. 手機品牌和型號
2. Android 版本
3. 控制台日誌（logcat 輸出）
4. 具體的測試步驟和結果

---

## ✅ 預期結果

修復後，應該能夠：
- ✅ 屏幕關閉後繼續播放
- ✅ 應用進入後台後繼續播放
- ✅ 長時間後台穩定運行
- ✅ 網路斷線自動重連
- ✅ 通知欄顯示播放狀態
- ✅ 從通知欄控制播放

測試愉快！🎵

