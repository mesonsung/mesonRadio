# æ’­æ”¾ä¸­æ–·å•é¡Œè¨ºæ–·
# Playback Interruption Debugging

## ğŸ” è¨ºæ–·æ­¥é©Ÿ

### 1ï¸âƒ£ ç¢ºèªæ˜¯å¦å®‰è£äº†æœ€æ–° APK

```bash
# æª¢æŸ¥æœ€æ–° APK æ™‚é–“
ls -lh android/app/build/outputs/apk/release/app-release.apk

# æ‡‰è©²é¡¯ç¤º: å 8 12:51 (2025-10-08 12:51)

# å®‰è£æœ€æ–° APK
adb install -r android/app/build/outputs/apk/release/app-release.apk
```

### 2ï¸âƒ£ æŸ¥çœ‹å¯¦æ™‚æ—¥èªŒ

æ‰“é–‹å…©å€‹çµ‚ç«¯çª—å£ï¼š

**çµ‚ç«¯ 1 - æŸ¥çœ‹ Keep Awake ç‹€æ…‹**:
```bash
adb logcat | grep "Keep Awake"
```

**çµ‚ç«¯ 2 - æŸ¥çœ‹æ’­æ”¾ç‹€æ…‹**:
```bash
adb logcat | grep -E "AudioPlayer|æ’­æ”¾|æš«åœ|åœæ­¢|Buffering"
```

### 3ï¸âƒ£ æ¸¬è©¦å ´æ™¯

#### å ´æ™¯ A: åŸºæœ¬æ’­æ”¾æ¸¬è©¦
1. å•Ÿå‹•æ‡‰ç”¨
2. é–‹å§‹æ’­æ”¾é›»å°
3. è§€å¯Ÿæ—¥èªŒï¼Œæ‡‰è©²çœ‹åˆ°ï¼š
   ```
   âœ… Keep Awake å·²æ¿€æ´»ï¼ˆå±å¹•é—œé–‰æ™‚ç¹¼çºŒæ’­æ”¾ï¼‰
   ğŸ“± é€šçŸ¥å·²é¡¯ç¤º: [é›»å°åç¨±] æ’­æ”¾ä¸­
   ```

#### å ´æ™¯ B: é–å±æ¸¬è©¦
1. æ’­æ”¾é›»å°
2. é–å®šå±å¹•ï¼ˆæŒ‰é›»æºéµï¼‰
3. ç­‰å¾… 1-2 åˆ†é˜
4. **é æœŸ**: éŸ³è¨Šç¹¼çºŒæ’­æ”¾
5. **å¦‚æœä¸­æ–·**: è¨˜éŒ„æ—¥èªŒä¸­çš„éŒ¯èª¤ä¿¡æ¯

#### å ´æ™¯ C: å¾Œå°æ¸¬è©¦
1. æ’­æ”¾é›»å°
2. æŒ‰ Home éµè¿”å›ä¸»å±å¹•
3. ç­‰å¾… 1-2 åˆ†é˜
4. **é æœŸ**: éŸ³è¨Šç¹¼çºŒæ’­æ”¾

---

## ğŸ› å¸¸è¦‹ä¸­æ–·åŸå› 

### åŸå›  1: é›»æ± å„ªåŒ– â­ **æœ€å¸¸è¦‹**

**ç—‡ç‹€**: é–å±å¾Œå¹¾åˆ†é˜éŸ³è¨Šåœæ­¢

**è§£æ±ºæ–¹æ³•**:
```bash
# åœ¨è¨­å‚™ä¸Šæ‰‹å‹•è¨­ç½®ï¼š
1. è¨­ç½® > æ‡‰ç”¨ > mesonRadio
2. é›»æ±  > ä¸é™åˆ¶
3. æˆ–è€…ï¼šé›»æ± å„ªåŒ– > ä¸å„ªåŒ–
```

**é©—è­‰**:
```bash
# æª¢æŸ¥æ‡‰ç”¨æ˜¯å¦è¢«å„ªåŒ–
adb shell dumpsys deviceidle whitelist | grep mesonradio
```

### åŸå›  2: Keep Awake æœªæ¿€æ´»

**ç—‡ç‹€**: æ—¥èªŒä¸­æ²’æœ‰ "Keep Awake å·²æ¿€æ´»" æ¶ˆæ¯

**æª¢æŸ¥**:
```bash
# æŸ¥çœ‹ Keep Awake ç‹€æ…‹
adb logcat | grep "Keep Awake"

# æ‡‰è©²çœ‹åˆ°ï¼š
# âœ… Keep Awake å·²æ¿€æ´»ï¼ˆå±å¹•é—œé–‰æ™‚ç¹¼çºŒæ’­æ”¾ï¼‰
```

**å¦‚æœæ²’æœ‰çœ‹åˆ°**: å¯èƒ½æ˜¯æ¬Šé™å•é¡Œæˆ–ä»£ç¢¼æœªæ­£ç¢ºåŸ·è¡Œ

### åŸå›  3: éŸ³è¨Šç„¦é»ä¸Ÿå¤±

**ç—‡ç‹€**: å…¶ä»–æ‡‰ç”¨æ’­æ”¾è²éŸ³æ™‚ä¸­æ–·

**æª¢æŸ¥æ—¥èªŒ**:
```bash
adb logcat | grep "Audio"
```

**è§£æ±º**: å·²åœ¨ä»£ç¢¼ä¸­é…ç½® `interruptionModeAndroid: DoNotMix`

### åŸå›  4: ç¶²è·¯å•é¡Œ

**ç—‡ç‹€**: æ—¥èªŒé¡¯ç¤ºç¶²è·¯éŒ¯èª¤æˆ–ç·©è¡è¶…æ™‚

**æª¢æŸ¥**:
```bash
adb logcat | grep -E "Network|ç¶²è·¯|Buffering|é‡è©¦"
```

### åŸå›  5: ç³»çµ±å¼·åˆ¶åœæ­¢

**ç—‡ç‹€**: æ‡‰ç”¨é€²ç¨‹è¢«ç³»çµ±æ®ºæ­»

**æª¢æŸ¥**:
```bash
# æŸ¥çœ‹æ‡‰ç”¨é€²ç¨‹ç‹€æ…‹
adb shell ps | grep mesonradio

# æŸ¥çœ‹ç³»çµ±æ—¥èªŒ
adb logcat | grep -E "killed|force"
```

---

## ğŸ”§ èª¿è©¦å‘½ä»¤é›†åˆ

### å¯¦æ™‚ç›£æ§

```bash
# å®Œæ•´æ—¥èªŒï¼ˆéæ¿¾é—œéµä¿¡æ¯ï¼‰
adb logcat | grep -E "Keep Awake|AudioPlayer|é€šçŸ¥|æ’­æ”¾|ç¶²è·¯|Battery"

# åªçœ‹éŒ¯èª¤
adb logcat *:E | grep mesonradio

# æŸ¥çœ‹æ‡‰ç”¨ç‹€æ…‹
adb shell dumpsys activity processes | grep mesonradio
```

### æ¬Šé™æª¢æŸ¥

```bash
# æŸ¥çœ‹å·²æˆäºˆçš„æ¬Šé™
adb shell dumpsys package com.meson.mesonradio | grep permission

# æŸ¥çœ‹é›»æ± å„ªåŒ–ç‹€æ…‹
adb shell dumpsys deviceidle whitelist
```

### æ‡‰ç”¨ä¿¡æ¯

```bash
# æŸ¥çœ‹æ‡‰ç”¨è©³æƒ…
adb shell dumpsys package com.meson.mesonradio

# æŸ¥çœ‹æ‡‰ç”¨æ´»å‹•
adb shell dumpsys activity com.meson.mesonradio
```

---

## ğŸ“ è«‹æä¾›ä»¥ä¸‹ä¿¡æ¯

ç‚ºäº†æ›´æº–ç¢ºåœ°è¨ºæ–·å•é¡Œï¼Œè«‹æä¾›ï¼š

### 1. ä¸­æ–·ç™¼ç”Ÿæ™‚é–“
- [ ] é–å±å¾Œç«‹å³ä¸­æ–·ï¼ˆ< 5ç§’ï¼‰
- [ ] é–å±å¾ŒçŸ­æ™‚é–“ä¸­æ–·ï¼ˆ5ç§’ - 1åˆ†é˜ï¼‰
- [ ] é–å±å¾Œè¼ƒé•·æ™‚é–“ä¸­æ–·ï¼ˆ1-5åˆ†é˜ï¼‰
- [ ] é–å±å¾Œå¾ˆé•·æ™‚é–“ä¸­æ–·ï¼ˆ> 5åˆ†é˜ï¼‰

### 2. ä¸­æ–·å ´æ™¯
- [ ] é–å®šå±å¹•å¾Œä¸­æ–·
- [ ] æŒ‰ Home éµå¾Œä¸­æ–·
- [ ] æ’­æ”¾ä¸€æ®µæ™‚é–“å¾Œè‡ªå‹•ä¸­æ–·
- [ ] ç¶²è·¯åˆ‡æ›æ™‚ä¸­æ–·
- [ ] å…¶ä»–æ‡‰ç”¨æ’­æ”¾è²éŸ³æ™‚ä¸­æ–·

### 3. æ—¥èªŒä¿¡æ¯

**åŸ·è¡Œä»¥ä¸‹å‘½ä»¤ä¸¦æä¾›è¼¸å‡º**:

```bash
# å•Ÿå‹•æ‡‰ç”¨ä¸¦æ’­æ”¾ï¼Œç„¶å¾Œé–å±ï¼Œç­‰å¾…ä¸­æ–·ç™¼ç”Ÿ
# åŒæ™‚åœ¨å¦ä¸€å€‹çµ‚ç«¯é‹è¡Œï¼š
adb logcat -d | grep -A 5 -B 5 "Keep Awake\|åœæ­¢\|ä¸­æ–·\|killed"
```

### 4. è¨­å‚™ä¿¡æ¯

```bash
# è¨­å‚™å‹è™Ÿå’Œ Android ç‰ˆæœ¬
adb shell getprop ro.product.model
adb shell getprop ro.build.version.release

# é›»æ± å„ªåŒ–ç‹€æ…‹
adb shell dumpsys deviceidle whitelist | grep mesonradio
```

---

## ğŸ¯ å¯èƒ½çš„é¡å¤–ä¿®å¾©

æ ¹æ“šæ‚¨çš„åé¥‹ï¼Œå¯èƒ½éœ€è¦ï¼š

### é¸é … 1: å¢åŠ  WakeLock å¼·åº¦

å¦‚æœ Keep Awake ä¸å¤ å¼·ï¼Œå¯ä»¥æ·»åŠ é¡å¤–çš„ WakeLockï¼š

```typescript
// åœ¨ AudioPlayerService.ts ä¸­æ·»åŠ 
import { Platform } from 'react-native';

// Android åŸç”Ÿ WakeLock
if (Platform.OS === 'android') {
  // éœ€è¦æ·»åŠ åŸç”Ÿæ¨¡å¡Š
}
```

### é¸é … 2: ä½¿ç”¨å‰å°æœå‹™å„ªå…ˆç´š

ç¢ºä¿é€šçŸ¥è¨­ç½®ç‚ºé«˜å„ªå…ˆç´šï¼š

```typescript
// åœ¨ MediaNotificationService.ts ä¸­
importance: Notifications.AndroidImportance.MAX, // æ”¹ç‚º MAX
```

### é¸é … 3: æ·»åŠ å¿ƒè·³æª¢æ¸¬

å®šæœŸç™¼é€å¿ƒè·³ä¿æŒé€£æ¥ï¼š

```typescript
// æ¯ 30 ç§’æª¢æŸ¥ä¸€æ¬¡æ’­æ”¾ç‹€æ…‹
setInterval(() => {
  if (this.shouldKeepPlaying && !this.isPlaying) {
    this.handlePlaybackError(new Error('Heartbeat check failed'));
  }
}, 30000);
```

---

## ğŸ“± å¿«é€Ÿæ¸¬è©¦è…³æœ¬

å‰µå»ºæ¸¬è©¦è…³æœ¬ `test_playback.sh`:

```bash
#!/bin/bash

echo "ğŸ” é–‹å§‹æ’­æ”¾æ¸¬è©¦..."

# 1. å®‰è£æœ€æ–° APK
echo "ğŸ“¦ å®‰è£æ‡‰ç”¨..."
adb install -r android/app/build/outputs/apk/release/app-release.apk

# 2. å•Ÿå‹•æ‡‰ç”¨
echo "ğŸš€ å•Ÿå‹•æ‡‰ç”¨..."
adb shell am start -n com.meson.mesonradio/.MainActivity

# 3. ç­‰å¾…æ‡‰ç”¨å•Ÿå‹•
sleep 5

# 4. ç›£æ§æ—¥èªŒ
echo "ğŸ“Š ç›£æ§æ—¥èªŒï¼ˆæŒ‰ Ctrl+C åœæ­¢ï¼‰..."
adb logcat -c  # æ¸…é™¤èˆŠæ—¥èªŒ
adb logcat | grep --line-buffered -E "Keep Awake|AudioPlayer|é€šçŸ¥|æ’­æ”¾|åœæ­¢|killed"
```

**ä½¿ç”¨æ–¹æ³•**:
```bash
chmod +x test_playback.sh
./test_playback.sh
```

---

## ğŸ’¡ è‡¨æ™‚æ¸¬è©¦æ–¹æ¡ˆ

å¦‚æœéœ€è¦å¿«é€Ÿæ¸¬è©¦ï¼Œå¯ä»¥ä½¿ç”¨ Expo Goï¼š

```bash
# 1. å•Ÿå‹•é–‹ç™¼æœå‹™å™¨
npm start

# 2. åœ¨æ‰‹æ©Ÿä¸Šç”¨ Expo Go æƒç¢¼

# 3. æ¸¬è©¦æ’­æ”¾
# æ³¨æ„ï¼šExpo Go å¯èƒ½æ²’æœ‰å®Œæ•´çš„å¾Œå°æ”¯æŒ
```

---

## ğŸ“ éœ€è¦çš„åé¥‹

è«‹å‘Šè¨´æˆ‘ï¼š

1. **æ˜¯å¦å®‰è£äº†æœ€æ–° APK**ï¼Ÿï¼ˆ12:51 ç”Ÿæˆçš„ï¼‰
2. **ä¸­æ–·ç™¼ç”Ÿçš„å…·é«”æ™‚æ©Ÿ**ï¼Ÿï¼ˆé–å±å¾Œå¤šä¹…ï¼‰
3. **æ—¥èªŒä¸­çœ‹åˆ°äº†ä»€éº¼**ï¼Ÿï¼ˆç‰¹åˆ¥æ˜¯ Keep Awake ç›¸é—œï¼‰
4. **è¨­å‚™å‹è™Ÿå’Œ Android ç‰ˆæœ¬**ï¼Ÿ
5. **æ˜¯å¦é—œé–‰äº†é›»æ± å„ªåŒ–**ï¼Ÿ

---

**æº–å‚™å¥½æä¾›é€™äº›ä¿¡æ¯å¾Œï¼Œæˆ‘å€‘å¯ä»¥é€²ä¸€æ­¥è¨ºæ–·å’Œä¿®å¾©å•é¡Œã€‚** ğŸ”§
