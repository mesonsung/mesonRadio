# è‡ªå‹•æ¢å¾©æ©Ÿåˆ¶æ›´æ–°
# Auto Recovery Mechanism Update

## ğŸ¯ æ–°å¢åŠŸèƒ½ï¼šä¸»å‹•å¥åº·æª¢æŸ¥

### å•é¡Œ
æ’­æ”¾ä¸­æ–·å¾Œç„¡æ³•è‡ªå‹•æ¢å¾©ï¼Œç‰¹åˆ¥æ˜¯ï¼š
- é–å±å¾Œé•·æ™‚é–“æ’­æ”¾åœæ­¢
- ç¶²è·¯æš«æ™‚ä¸­æ–·å¾Œç„¡æ³•æ¢å¾©
- Sound å¯¦ä¾‹æå£ä½†æœªè§¸ç™¼éŒ¯èª¤å›èª¿

### è§£æ±ºæ–¹æ¡ˆï¼šå¥åº·æª¢æŸ¥æ©Ÿåˆ¶

æ·»åŠ äº†ä¸»å‹•çš„å¥åº·æª¢æŸ¥ç³»çµ±ï¼Œæ¯30ç§’è‡ªå‹•æª¢æŸ¥æ’­æ”¾ç‹€æ…‹ä¸¦å˜—è©¦æ¢å¾©ã€‚

---

## ğŸ”§ å¯¦ç¾ç´°ç¯€

### 1. æ–°å¢è®Šé‡

```typescript
private static healthCheckInterval: NodeJS.Timeout | null = null; // å¥åº·æª¢æŸ¥è¨ˆæ™‚å™¨
private static lastHealthCheckTime: number = 0; // ä¸Šæ¬¡å¥åº·æª¢æŸ¥æ™‚é–“
```

### 2. å¥åº·æª¢æŸ¥é‚è¼¯

```typescript
private static startHealthCheck(): void {
  console.log('ğŸ¥ å•Ÿå‹•æ’­æ”¾å¥åº·æª¢æŸ¥ï¼ˆæ¯30ç§’ï¼‰');
  
  this.healthCheckInterval = setInterval(async () => {
    if (this.shouldKeepPlaying && !this.isUserStopped) {
      // æª¢æŸ¥1: Sound å¯¦ä¾‹æ˜¯å¦å­˜åœ¨
      if (!this.sound) {
        console.warn('âš ï¸ å¥åº·æª¢æŸ¥: sound å¯¦ä¾‹ä¸å­˜åœ¨ï¼Œå˜—è©¦æ¢å¾©...');
        await this.startPlayback();
        return;
      }
      
      // æª¢æŸ¥2: Sound æ˜¯å¦å·²åŠ è¼‰
      const status = await this.sound.getStatusAsync();
      if (!status.isLoaded) {
        console.warn('âš ï¸ å¥åº·æª¢æŸ¥: sound æœªåŠ è¼‰ï¼Œå˜—è©¦æ¢å¾©...');
        await this.startPlayback();
        return;
      }
      
      // æª¢æŸ¥3: æ˜¯å¦æ‡‰è©²æ’­æ”¾ä½†å¯¦éš›åœæ­¢
      if (!status.isPlaying && !status.isBuffering) {
        const timeSinceLastPlaying = Date.now() - this.lastPlayingTime;
        if (timeSinceLastPlaying > 60000) { // è¶…é1åˆ†é˜
          console.warn('âš ï¸ å·²åœæ­¢æ’­æ”¾éä¹…ï¼Œå¼·åˆ¶æ¢å¾©');
          await this.startPlayback();
        }
      }
    }
  }, 30000); // æ¯30ç§’
}
```

### 3. è§¸ç™¼æ™‚æ©Ÿ

```typescript
// æ’­æ”¾æˆåŠŸå¾Œå•Ÿå‹•å¥åº·æª¢æŸ¥
await sound.playAsync();
this.startHealthCheck();
```

### 4. åœæ­¢æ™‚æ©Ÿ

```typescript
// ç”¨æˆ¶ä¸»å‹•åœæ­¢æ™‚
static async stop(): Promise<void> {
  this.stopHealthCheck();
  // ...
}

// æ¸…ç†æ™‚
static async cleanup(): Promise<void> {
  this.stopHealthCheck();
  // ...
}
```

---

## ğŸ“Š æª¢æŸ¥æµç¨‹åœ–

```
æ¯30ç§’è‡ªå‹•æª¢æŸ¥
       â†“
æ˜¯å¦æ‡‰è©²æ’­æ”¾ï¼Ÿ
       â†“ æ˜¯
Sound å¯¦ä¾‹å­˜åœ¨ï¼Ÿ â†’ å¦ â†’ é‡æ–°å‰µå»ºä¸¦æ’­æ”¾
       â†“ æ˜¯
Sound å·²åŠ è¼‰ï¼Ÿ â†’ å¦ â†’ é‡æ–°å‰µå»ºä¸¦æ’­æ”¾
       â†“ æ˜¯
æ­£åœ¨æ’­æ”¾æˆ–ç·©è¡ï¼Ÿ â†’ å¦ â†’ æª¢æŸ¥åœæ­¢æ™‚é–“
       â†“            â†“
     ç¹¼çºŒç›£æ§    è¶…é1åˆ†é˜ï¼Ÿ â†’ æ˜¯ â†’ å¼·åˆ¶æ¢å¾©
                     â†“ å¦
                  ç¹¼çºŒç›£æ§
```

---

## âœ¨ å„ªå‹¢

### 1. ä¸»å‹•æª¢æ¸¬ vs è¢«å‹•ç­‰å¾…

**ä¹‹å‰**:
- åªåœ¨éŒ¯èª¤å›èª¿æ™‚å˜—è©¦æ¢å¾©
- å¦‚æœéŒ¯èª¤æœªè§¸ç™¼ï¼Œç„¡æ³•è‡ªå‹•æ¢å¾©

**ç¾åœ¨**:
- å®šæœŸä¸»å‹•æª¢æŸ¥ç‹€æ…‹
- å³ä½¿æ²’æœ‰éŒ¯èª¤å›èª¿ä¹Ÿèƒ½ç™¼ç¾å•é¡Œ

### 2. å¤šå±¤æª¢æŸ¥

1. **å¯¦ä¾‹æª¢æŸ¥**: Sound å°è±¡æ˜¯å¦å­˜åœ¨
2. **åŠ è¼‰æª¢æŸ¥**: Sound æ˜¯å¦æ­£ç¢ºåŠ è¼‰
3. **æ’­æ”¾æª¢æŸ¥**: æ˜¯å¦çœŸçš„åœ¨æ’­æ”¾
4. **æ™‚é–“æª¢æŸ¥**: åœæ­¢æ’­æ”¾æ˜¯å¦éä¹…

### 3. å®¹éŒ¯è™•ç†

```typescript
try {
  const status = await this.sound.getStatusAsync();
  // ...
} catch (statusError) {
  console.error('âŒ å¥åº·æª¢æŸ¥: ç²å–ç‹€æ…‹å¤±æ•—', statusError);
  // å¦‚æœç„¡æ³•ç²å–ç‹€æ…‹ï¼ŒSound å¯èƒ½å·²æå£
  await this.startPlayback();
}
```

---

## ğŸ§ª æ¸¬è©¦å ´æ™¯

### å ´æ™¯ 1: é–å±é•·æ™‚é–“æ’­æ”¾

```
1. é–‹å§‹æ’­æ”¾
2. é–å®šå±å¹•
3. ç­‰å¾… 2 åˆ†é˜

é æœŸçµæœ:
- æ¯ 30 ç§’é€²è¡Œå¥åº·æª¢æŸ¥
- å¦‚æœåœæ­¢ï¼Œåœ¨ä¸‹æ¬¡æª¢æŸ¥æ™‚è‡ªå‹•æ¢å¾©
- æ—¥èªŒé¡¯ç¤º: "ğŸ¥ å•Ÿå‹•æ’­æ”¾å¥åº·æª¢æŸ¥"
```

### å ´æ™¯ 2: ç¶²è·¯æš«æ™‚ä¸­æ–·

```
1. é–‹å§‹æ’­æ”¾
2. é—œé–‰ WiF
3. ç­‰å¾… 30 ç§’
4. æ‰“é–‹ WiFi

é æœŸçµæœ:
- ç¶²è·¯ä¸­æ–·æ™‚è§¸ç™¼éŒ¯èª¤æ¢å¾©
- å¥åº·æª¢æŸ¥ä½œç‚ºå‚™ç”¨æ©Ÿåˆ¶
- å³ä½¿éŒ¯èª¤æ¢å¾©å¤±æ•—ï¼Œå¥åº·æª¢æŸ¥ä¹Ÿæœƒå˜—è©¦æ¢å¾©
```

### å ´æ™¯ 3: Sound å¯¦ä¾‹æå£

```
1. é–‹å§‹æ’­æ”¾
2. ç³»çµ±å¼·åˆ¶å›æ”¶è³‡æº
3. Sound å¯¦ä¾‹è®Šç‚º null

é æœŸçµæœ:
- ä¸‹æ¬¡å¥åº·æª¢æŸ¥ï¼ˆæœ€å¤š30ç§’å…§ï¼‰ç™¼ç¾ Sound ç‚º null
- è‡ªå‹•é‡æ–°å‰µå»ºä¸¦é–‹å§‹æ’­æ”¾
- æ—¥èªŒé¡¯ç¤º: "âš ï¸ å¥åº·æª¢æŸ¥: sound å¯¦ä¾‹ä¸å­˜åœ¨ï¼Œå˜—è©¦æ¢å¾©..."
```

---

## ğŸ“ æ—¥èªŒç¤ºä¾‹

### æ­£å¸¸é‹è¡Œ

```
ğŸ¥ å•Ÿå‹•æ’­æ”¾å¥åº·æª¢æŸ¥ï¼ˆæ¯30ç§’ï¼‰
... (30ç§’å¾Œ)
[å¥åº·æª¢æŸ¥] æ’­æ”¾ç‹€æ…‹æ­£å¸¸
... (30ç§’å¾Œ)
[å¥åº·æª¢æŸ¥] æ’­æ”¾ç‹€æ…‹æ­£å¸¸
```

### æª¢æ¸¬åˆ°å•é¡Œä¸¦æ¢å¾©

```
ğŸ¥ å•Ÿå‹•æ’­æ”¾å¥åº·æª¢æŸ¥ï¼ˆæ¯30ç§’ï¼‰
... (30ç§’å¾Œ)
âš ï¸ å¥åº·æª¢æŸ¥: æ‡‰è©²æ’­æ”¾ä½†å·²åœæ­¢ï¼Œå˜—è©¦æ¢å¾©...
âš ï¸ å·²åœæ­¢æ’­æ”¾ 65 ç§’ï¼Œå¼·åˆ¶æ¢å¾©
ğŸµ Starting playback for: [é›»å°åç¨±]
ğŸµ Loading stream from: [URL]
Stream playing successfully
âœ… Keep Awake å·²æ¿€æ´»ï¼ˆå±å¹•é—œé–‰æ™‚ç¹¼çºŒæ’­æ”¾ï¼‰
```

### Sound å¯¦ä¾‹æå£

```
ğŸ¥ å•Ÿå‹•æ’­æ”¾å¥åº·æª¢æŸ¥ï¼ˆæ¯30ç§’ï¼‰
... (30ç§’å¾Œ)
âš ï¸ å¥åº·æª¢æŸ¥: sound å¯¦ä¾‹ä¸å­˜åœ¨ï¼Œå˜—è©¦æ¢å¾©...
ğŸµ Starting playback for: [é›»å°åç¨±]
ğŸµ Loading stream from: [URL]
Stream playing successfully
```

---

## âš™ï¸ é…ç½®é¸é …

### èª¿æ•´æª¢æŸ¥é–“éš”

```typescript
// åœ¨ startHealthCheck() ä¸­ä¿®æ”¹
setInterval(async () => {
  // ...
}, 30000); // â† ä¿®æ”¹é€™å€‹å€¼ï¼ˆæ¯«ç§’ï¼‰

// å»ºè­°ç¯„åœ:
// - 15000 (15ç§’) - æ›´å¿«æ¢å¾©ï¼Œä½†æ›´è€—é›»
// - 30000 (30ç§’) - å¹³è¡¡ (é»˜èª)
// - 60000 (60ç§’) - çœé›»ï¼Œä½†æ¢å¾©è¼ƒæ…¢
```

### èª¿æ•´åœæ­¢é–¾å€¼

```typescript
// è¶…éå¤šä¹…åœæ­¢æ‰è§¸ç™¼æ¢å¾©
if (timeSinceLastPlaying > 60000) { // â† ä¿®æ”¹é€™å€‹å€¼ï¼ˆæ¯«ç§’ï¼‰
  await this.startPlayback();
}

// å»ºè­°ç¯„åœ:
// - 30000 (30ç§’) - å¿«é€Ÿæ¢å¾©
// - 60000 (60ç§’) - å¹³è¡¡ (é»˜èª)
// - 120000 (120ç§’) - å¯¬é¬†
```

---

## ğŸ¯ èˆ‡ç¾æœ‰æ©Ÿåˆ¶çš„é…åˆ

### å¤šå±¤ä¿è­·

1. **å¯¦æ™‚éŒ¯èª¤è™•ç†** - ç«‹å³éŸ¿æ‡‰éŒ¯èª¤
   ```typescript
   onPlaybackStatusUpdate() {
     if (status.error) {
       this.handlePlaybackError();
     }
   }
   ```

2. **ç¶²è·¯ç›£è½** - ç¶²è·¯æ¢å¾©æ™‚é‡é€£
   ```typescript
   BackgroundTaskService.setNetworkCallback((isConnected) => {
     if (isConnected && this.shouldKeepPlaying) {
       this.handlePlaybackError();
     }
   });
   ```

3. **ç·©è¡è¶…æ™‚** - é•·æ™‚é–“ç·©è¡æ™‚é‡è©¦
   ```typescript
   setTimeout(() => {
     this.handlePlaybackError();
   }, Config.NETWORK_RETRY.bufferingTimeout);
   ```

4. **å¥åº·æª¢æŸ¥** â­ **æ–°å¢** - å®šæœŸä¸»å‹•æª¢æŸ¥
   ```typescript
   setInterval(() => {
     if (æ‡‰è©²æ’­æ”¾ä½†å·²åœæ­¢) {
       await this.startPlayback();
     }
   }, 30000);
   ```

---

## ğŸ“š æ›´æ–°çš„æ–‡ä»¶

- âœ… `src/services/AudioPlayerService.ts` - æ·»åŠ å¥åº·æª¢æŸ¥æ©Ÿåˆ¶

---

## ğŸš€ ä½¿ç”¨èªªæ˜

### é‡æ–°æ§‹å»º APK

```bash
cd android
./gradlew assembleRelease
```

### å®‰è£æ¸¬è©¦

```bash
adb install -r android/app/build/outputs/apk/release/app-release.apk
```

### æŸ¥çœ‹æ—¥èªŒ

```bash
# ç›£æ§å¥åº·æª¢æŸ¥
adb logcat | grep "å¥åº·æª¢æŸ¥\|Health"

# ç›£æ§æ¢å¾©
adb logcat | grep "æ¢å¾©\|Recovery"
```

---

## âœ… é©—è­‰æ¸…å–®

æ¸¬è©¦ä»¥ä¸‹å ´æ™¯ç¢ºèªåŠŸèƒ½æ­£å¸¸ï¼š

- [ ] æ’­æ”¾é–‹å§‹å¾Œçœ‹åˆ° "ğŸ¥ å•Ÿå‹•æ’­æ”¾å¥åº·æª¢æŸ¥"
- [ ] é–å±å¾Œæ’­æ”¾ç¹¼çºŒï¼ˆè¶…é 2 åˆ†é˜ï¼‰
- [ ] å¦‚æœæ’­æ”¾åœæ­¢ï¼Œ30ç§’å…§è‡ªå‹•æ¢å¾©
- [ ] ç¶²è·¯ä¸­æ–·å¾Œè‡ªå‹•æ¢å¾©
- [ ] åœæ­¢æ’­æ”¾æ™‚å¥åº·æª¢æŸ¥åœæ­¢

---

**æ›´æ–°æ—¥æœŸ**: 2025-10-08  
**ç‰ˆæœ¬**: v1.0.3  
**ç‹€æ…‹**: âœ… å¥åº·æª¢æŸ¥æ©Ÿåˆ¶å·²æ·»åŠ 

**ç¾åœ¨æ’­æ”¾æ‡‰è©²èƒ½å¤ è‡ªå‹•æ¢å¾©äº†ï¼** ğŸ‰
