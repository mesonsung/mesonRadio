# 系統媒體控制整合說明

## ✨ 新功能

已成功整合系統級媒體控制，現在支持：

### 🎮 控制功能
1. **鎖屏控制** - 在鎖定螢幕上顯示播放控制
2. **通知欄控制** - 通知欄中的播放/暫停/停止按鈕
3. **藍牙耳機控制** - 支持藍牙耳機的播放/暫停按鈕
4. **車載系統控制** - 支持 Android Auto 等車載系統
5. **智能手錶控制** - 支持 Wear OS 等智能手錶

### 📱 顯示內容
- 電台名稱
- 電台圖標
- 播放狀態（正在播放/已暫停）
- 播放控制按鈕（播放/暫停/停止）

## 🏗️ 技術架構

### 雙引擎架構
我們採用混合架構，結合兩個播放引擎的優勢：

#### 1. Expo AV（主播放引擎）
- **功能**：實際音訊播放
- **優勢**：成熟穩定、支持直播流
- **責任**：
  - 音訊數據流處理
  - 緩衝管理
  - 網路重試
  - 音質控制

#### 2. React Native Track Player（媒體會話引擎）
- **功能**：系統級媒體控制整合
- **優勢**：完整的 MediaSession API 支持
- **責任**：
  - 鎖屏控制顯示
  - 通知欄媒體控制
  - 藍牙耳機響應
  - 車載系統整合

### 為什麼使用雙引擎？

1. **Expo AV** - 專長於音訊流處理，但媒體會話支持有限
2. **Track Player** - 專長於系統控制整合，但對複雜直播流支持較弱
3. **組合優勢** - 兩者結合，取長補短

## 📁 新增文件

### 1. `src/services/TrackPlayerService.ts`
Track Player 封裝服務，提供：
- 媒體會話初始化
- 播放狀態同步
- 媒體元數據更新
- 控制按鈕回調

### 2. `src/services/playbackService.ts`
後台播放服務，處理：
- 遠端播放事件（鎖屏/通知欄按鈕）
- 音訊焦點管理
- 播放錯誤處理

### 3. `index.js`
應用入口點，註冊 Track Player 服務

## 🔄 修改文件

### 1. `src/services/AudioPlayerService.ts`
整合 Track Player：
- 初始化時啟動 Track Player
- 播放時更新媒體會話
- 暫停/恢復時同步狀態
- 停止時清理媒體會話

### 2. `package.json`
- 新增 `react-native-track-player` 依賴
- 修改入口點為 `index.js`

## 🚀 工作流程

### 播放流程
```
用戶點擊播放
    ↓
AudioPlayerService.play()
    ├─→ Expo AV: 開始音訊播放
    └─→ Track Player: 更新媒體會話
    ↓
系統顯示鎖屏控制
```

### 鎖屏控制流程
```
用戶在鎖屏按下暫停
    ↓
Track Player 接收事件
    ↓
playbackService.ts 處理事件
    ↓
觸發 AudioPlayerService.pause()
    ├─→ Expo AV: 暫停音訊
    └─→ Track Player: 更新狀態
    ↓
鎖屏顯示暫停狀態
```

### 狀態同步
```
Expo AV (實際播放)
    ↕ 狀態同步
Track Player (媒體會話)
    ↕ 顯示控制
系統 UI (鎖屏/通知欄)
```

## 🎯 關鍵特性

### 1. 防止多個播放實體
- 保持原有的雙重鎖機制
- Track Player 不實際播放音訊
- 只用於媒體會話和控制顯示

### 2. 優雅降級
- Track Player 初始化失敗不影響播放
- 自動降級到基本通知模式
- 日誌記錄所有狀態變化

### 3. 完整的生命週期管理
- 初始化：同時啟動兩個引擎
- 播放：同步更新兩個引擎
- 停止：正確清理所有資源

## 🔧 配置說明

### Track Player 配置
```typescript
capabilities: [
  Capability.Play,      // 播放按鈕
  Capability.Pause,     // 暫停按鈕
  Capability.Stop,      // 停止按鈕
  Capability.SeekTo,    // 進度條（直播流不顯示）
]
```

### 緊湊通知欄按鈕
```typescript
compactCapabilities: [
  Capability.Play,
  Capability.Pause,
  Capability.Stop,
]
```

## 📝 使用示例

### 基本使用（無需修改現有代碼）
所有整合都在 `AudioPlayerService` 內部完成，UI 層無需改動：

```typescript
// 播放（自動更新媒體會話）
await AudioPlayerService.play(station);

// 暫停（自動同步到鎖屏）
await AudioPlayerService.pause();

// 恢復（自動同步到鎖屏）
await AudioPlayerService.resume();

// 停止（自動清理媒體會話）
await AudioPlayerService.stop();
```

### 高級使用（如需自定義）
```typescript
// 檢查 Track Player 是否可用
if (TrackPlayerService.isReady()) {
  // 更新媒體元數據
  await TrackPlayerService.updateNowPlaying(station, true);
}
```

## 🐛 故障排除

### Track Player 未初始化
**現象**：日誌顯示 "⚠️ Track Player 初始化失敗"

**原因**：
- Native 模塊未正確鏈接
- 權限不足
- Android 版本過低

**解決**：
1. 檢查日誌獲取詳細錯誤
2. 應用會自動降級到基本通知模式
3. 播放功能不受影響

### 鎖屏控制不顯示
**檢查清單**：
- [ ] Track Player 是否初始化成功？
- [ ] 媒體會話是否更新？
- [ ] 通知權限是否授予？
- [ ] 系統版本是否支持？（Android 5.0+）

### 藍牙耳機控制無響應
**檢查清單**：
- [ ] 藍牙權限是否授予？
- [ ] Track Player 事件監聽是否正常？
- [ ] 音訊焦點是否正確管理？

## 🎨 自定義

### 修改通知欄樣式
編輯 `TrackPlayerService.ts` 中的配置：

```typescript
await TrackPlayer.updateOptions({
  android: {
    // 自定義通知欄顏色、圖標等
  },
  // ...
});
```

### 添加更多控制按鈕
在 `capabilities` 中添加：

```typescript
capabilities: [
  Capability.Play,
  Capability.Pause,
  Capability.Stop,
  Capability.SkipToNext,     // 下一首
  Capability.SkipToPrevious, // 上一首
]
```

## 📊 日誌說明

### 成功日誌
```
✅ Track Player 已初始化（系統媒體控制）
✅ Track Player 媒體會話已更新
✅ Track Player 已停止
✅ Track Player 已清理
```

### 警告日誌
```
⚠️ Track Player 初始化失敗（降級到基本通知）
⚠️ 更新 Track Player 媒體會話失敗
⚠️ Track Player 停止失敗
```

### 控制事件日誌
```
🎵 遠端播放事件（通知欄/鎖屏按下播放）
⏸️ 遠端暫停事件（通知欄/鎖屏按下暫停）
⏹️ 遠端停止事件（通知欄/鎖屏按下停止）
🔊 音訊焦點改變
```

## ✅ 測試清單

### 基本功能
- [ ] 播放電台後，鎖屏顯示控制
- [ ] 通知欄顯示播放控制
- [ ] 鎖屏播放按鈕可用
- [ ] 鎖屏暫停按鈕可用
- [ ] 鎖屏停止按鈕可用

### 高級功能
- [ ] 藍牙耳機播放/暫停控制
- [ ] 車載系統顯示電台信息
- [ ] 其他應用播放時自動暫停
- [ ] 來電時自動暫停
- [ ] 音訊焦點正確管理

### 穩定性
- [ ] Track Player 失敗不影響播放
- [ ] 快速切換電台正常
- [ ] 長時間播放穩定
- [ ] 應用後台運行正常
- [ ] 資源正確清理

## 📱 建置新 APK

整合完成後，需要重新建置 APK：

```bash
# 方法 1: EAS Build（推薦）
eas build -p android --profile preview --local

# 方法 2: Gradle（需要配置環境）
cd android && ./gradlew assembleRelease
```

建置時間：約 5-10 分鐘

## 🎉 總結

此次整合為 mesonRadio 添加了完整的系統級媒體控制支持，包括：

✅ **鎖屏控制** - 無需解鎖即可控制播放  
✅ **通知欄按鈕** - 快速訪問播放控制  
✅ **藍牙支持** - 耳機和車載系統控制  
✅ **優雅降級** - 失敗不影響基本功能  
✅ **無縫整合** - UI 層無需任何修改  
✅ **完全兼容** - 保持原有所有功能  

現在您的網路電台應用具備了專業媒體應用的所有特性！🎵

