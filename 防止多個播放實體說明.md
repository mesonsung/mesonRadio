# é˜²æ­¢å¤šå€‹æ’­æ”¾å¯¦é«” - æŠ€è¡“èªªæ˜

## å•é¡Œæè¿°
åœ¨å¿«é€Ÿé»æ“Šæ’­æ”¾æŒ‰éˆ•æˆ–ç¶²è·¯é‡è©¦æ™‚ï¼Œå¯èƒ½æœƒå‰µå»ºå¤šå€‹éŸ³è¨Šæ’­æ”¾å¯¦é«”ï¼ˆAudio.Sound å¯¦ä¾‹ï¼‰ï¼Œå°è‡´ï¼š
- å¤šå€‹éŸ³è¨ŠæµåŒæ™‚æ’­æ”¾
- è³‡æºæ´©æ¼
- æ’­æ”¾æ§åˆ¶æ··äº‚

## è§£æ±ºæ–¹æ¡ˆ

### 1. é›™é‡é–æ©Ÿåˆ¶

#### 1.1 æ’­æ”¾æ–¹æ³•é– (`playLock`)
- **ä½ç½®**: `AudioPlayerService.play()` æ–¹æ³•
- **åŠŸèƒ½**: é˜²æ­¢ä½µç™¼èª¿ç”¨ play() æ–¹æ³•
- **å¯¦ç¾**:
  ```typescript
  private static playLock: boolean = false;
  
  static async play(station: Station): Promise<void> {
    // ğŸ”’ é˜²æ­¢ä¸¦ç™¼èª¿ç”¨
    if (this.playLock) {
      console.log('âš ï¸ Play already in progress, ignoring duplicate request');
      return;
    }
    
    this.playLock = true;
    try {
      // ... æ’­æ”¾é‚è¼¯
    } finally {
      // å»¶é²é‡‹æ”¾é–ï¼Œç¢ºä¿æ’­æ”¾å™¨å®Œå…¨åˆå§‹åŒ–
      setTimeout(() => {
        this.playLock = false;
      }, 1000);
    }
  }
  ```

#### 1.2 åˆå§‹åŒ–é– (`isInitializing`)
- **ä½ç½®**: `AudioPlayerService.playRadioStream()` æ–¹æ³•
- **åŠŸèƒ½**: é˜²æ­¢åŒæ™‚å‰µå»ºå¤šå€‹ Audio.Sound å¯¦ä¾‹
- **å¯¦ç¾**:
  ```typescript
  private static isInitializing: boolean = false;
  
  private static async playRadioStream(url: string): Promise<void> {
    // ğŸ”’ é˜²æ­¢å¤šå€‹æ’­æ”¾å¯¦é«”åŒæ™‚åˆå§‹åŒ–
    if (this.isInitializing) {
      console.log('âš ï¸ Sound initialization already in progress');
      // ç­‰å¾…ä¸¦è·³éé‡è¤‡å˜—è©¦
      return;
    }
    
    this.isInitializing = true;
    try {
      // æ¸…ç†èˆŠå¯¦ä¾‹
      if (this.sound) {
        await this.sound.unloadAsync();
        this.sound = null;
      }
      
      // å‰µå»ºæ–°å¯¦ä¾‹
      const { sound } = await Audio.Sound.createAsync(...);
      this.sound = sound;
    } finally {
      // ğŸ”“ é‡‹æ”¾åˆå§‹åŒ–é–
      this.isInitializing = false;
    }
  }
  ```

### 2. å®Œæ•´çš„æ¸…ç†æ©Ÿåˆ¶

#### 2.1 stopInternal() æ–¹æ³•
```typescript
private static async stopInternal(): Promise<void> {
  try {
    // ğŸ”“ ç¢ºä¿æ¸…é™¤åˆå§‹åŒ–é–
    this.isInitializing = false;
    
    if (this.sound) {
      await this.sound.stopAsync();
      await this.sound.unloadAsync();
      this.sound = null;
    }
  } catch (error) {
    // éŒ¯èª¤æƒ…æ³ä¸‹ä¹Ÿè¦æ¸…ç†
    this.sound = null;
    this.isInitializing = false;
  }
}
```

#### 2.2 cleanup() æ–¹æ³•
```typescript
static async cleanup(): Promise<void> {
  try {
    // ğŸ”“ é‡‹æ”¾æ‰€æœ‰é–
    this.playLock = false;
    this.isInitializing = false;
    
    // ... å…¶ä»–æ¸…ç†é‚è¼¯
  } catch (error) {
    // ç¢ºä¿éŒ¯èª¤æ™‚ä¹Ÿé‡‹æ”¾é–
    this.playLock = false;
    this.isInitializing = false;
    this.sound = null;
  }
}
```

## ä¿è­·æ©Ÿåˆ¶ç¸½çµ

### ä¸‰å±¤ä¿è­·
1. **å…¥å£ä¿è­·** (`playLock`): é˜²æ­¢ç”¨æˆ¶å¿«é€Ÿå¤šæ¬¡é»æ“Šæ’­æ”¾
2. **å¯¦ä¾‹ä¿è­·** (`isInitializing`): é˜²æ­¢å‰µå»ºå¤šå€‹ Audio.Sound å¯¦ä¾‹
3. **æ¸…ç†ä¿è­·**: ç¢ºä¿æ‰€æœ‰æƒ…æ³ä¸‹éƒ½æœƒæ¸…ç†é–å’Œè³‡æº

### é–çš„ç”Ÿå‘½é€±æœŸ
```
ç”¨æˆ¶é»æ“Šæ’­æ”¾
    â†“
playLock = true (1ç§’å¾Œè‡ªå‹•é‡‹æ”¾)
    â†“
æ¸…ç†èˆŠå¯¦ä¾‹
    â†“
isInitializing = true
    â†“
å‰µå»ºæ–° Sound å¯¦ä¾‹
    â†“
isInitializing = false (try-finally ä¿è­‰)
    â†“
æ’­æ”¾é–‹å§‹
```

## æ—¥èªŒè¿½è¹¤

æ–°å¢çš„æ—¥èªŒä¿¡æ¯ï¼š
- `ğŸ”’ Play lock acquired for station: XXX` - ç²å–æ’­æ”¾é–
- `ğŸ”“ Play lock released` - é‡‹æ”¾æ’­æ”¾é–
- `âš ï¸ Play already in progress, ignoring duplicate request` - æ‹’çµ•é‡è¤‡è«‹æ±‚
- `ğŸ”’ Sound initialization lock acquired` - ç²å–åˆå§‹åŒ–é–
- `ğŸ”“ Sound initialization lock released` - é‡‹æ”¾åˆå§‹åŒ–é–
- `âš ï¸ Sound initialization already in progress` - æª¢æ¸¬åˆ°é‡è¤‡åˆå§‹åŒ–
- `âœ… Sound instance created successfully` - å¯¦ä¾‹å‰µå»ºæˆåŠŸ
- `âœ… Previous sound instance unloaded` - èˆŠå¯¦ä¾‹å·²å¸è¼‰

## æ¸¬è©¦å ´æ™¯

### å ´æ™¯ 1: å¿«é€Ÿé€£çºŒé»æ“Šæ’­æ”¾
- **é æœŸ**: åªæœ‰ç¬¬ä¸€æ¬¡é»æ“Šç”Ÿæ•ˆï¼Œå¾ŒçºŒé»æ“Šè¢«å¿½ç•¥
- **æ—¥èªŒ**: 
  ```
  ğŸ”’ Play lock acquired
  âš ï¸ Play already in progress, ignoring duplicate request
  âš ï¸ Play already in progress, ignoring duplicate request
  ```

### å ´æ™¯ 2: ç¶²è·¯é‡è©¦æœŸé–“åˆ‡æ›é›»å°
- **é æœŸ**: èˆŠé›»å°åœæ­¢ï¼Œæ–°é›»å°é–‹å§‹æ’­æ”¾ï¼Œä¸æœƒæœ‰å¤šå€‹å¯¦ä¾‹
- **æ—¥èªŒ**:
  ```
  ğŸ”’ Play lock acquired for station: A
  ğŸ”’ Sound initialization lock acquired
  ... (ç¶²è·¯å•é¡Œ)
  ğŸ”’ Play lock acquired for station: B
  âœ… Previous sound instance unloaded
  ğŸ”’ Sound initialization lock acquired
  ```

### å ´æ™¯ 3: åŒæ™‚ç™¼ç”Ÿçš„åˆå§‹åŒ–è«‹æ±‚
- **é æœŸ**: ç¬¬äºŒå€‹è«‹æ±‚ç­‰å¾…ä¸¦è·³é
- **æ—¥èªŒ**:
  ```
  ğŸ”’ Sound initialization lock acquired
  âš ï¸ Sound initialization already in progress, waiting...
  âš ï¸ Still initializing, skipping duplicate attempt
  ```

## æŠ€è¡“ç´°ç¯€

### ç‚ºä»€éº¼éœ€è¦å…©å€‹é–ï¼Ÿ

1. **playLock** (ç²—ç²’åº¦):
   - ä¿è­·æ•´å€‹æ’­æ”¾æµç¨‹
   - é˜²æ­¢ç”¨æˆ¶æ“ä½œå°è‡´çš„ä¸¦ç™¼
   - 1ç§’å»¶é²é‡‹æ”¾ç¢ºä¿åˆå§‹åŒ–å®Œæˆ

2. **isInitializing** (ç´°ç²’åº¦):
   - ä¿è­· Sound å¯¦ä¾‹å‰µå»º
   - é˜²æ­¢é‡è©¦æ©Ÿåˆ¶å°è‡´çš„ä¸¦ç™¼
   - ç«‹å³é‡‹æ”¾ï¼ˆtry-finallyï¼‰

### ç‚ºä»€éº¼ playLock å»¶é²é‡‹æ”¾ï¼Ÿ

å»¶é²é‡‹æ”¾ï¼ˆ1ç§’ï¼‰ç¢ºä¿ï¼š
- Audio.Sound å¯¦ä¾‹å®Œå…¨åˆå§‹åŒ–
- ç¶²è·¯é€£æ¥å·²å»ºç«‹
- æ’­æ”¾å·²çœŸæ­£é–‹å§‹
- é¿å…éæ—©å…è¨±æ–°çš„æ’­æ”¾è«‹æ±‚

### éŒ¯èª¤è™•ç†

æ‰€æœ‰é–éƒ½åœ¨ä»¥ä¸‹æƒ…æ³ç¢ºä¿é‡‹æ”¾ï¼š
- æ­£å¸¸å®Œæˆï¼ˆfinally å¡Šï¼‰
- ç™¼ç”Ÿç•°å¸¸ï¼ˆcatch å¡Šï¼‰
- ç”¨æˆ¶åœæ­¢ï¼ˆstop/cleanup æ–¹æ³•ï¼‰
- æ‡‰ç”¨æ¸…ç†ï¼ˆcleanup æ–¹æ³•ï¼‰

## ç¸½çµ

é€šéé›™é‡é–æ©Ÿåˆ¶å’Œå®Œæ•´çš„æ¸…ç†é‚è¼¯ï¼Œç¾åœ¨èƒ½å¤ ï¼š
âœ… é˜²æ­¢å¿«é€Ÿé»æ“Šå‰µå»ºå¤šå€‹æ’­æ”¾å¯¦é«”
âœ… é˜²æ­¢ç¶²è·¯é‡è©¦æ™‚å‰µå»ºå¤šå€‹å¯¦ä¾‹
âœ… ç¢ºä¿èˆŠå¯¦ä¾‹è¢«æ­£ç¢ºæ¸…ç†
âœ… æä¾›æ¸…æ™°çš„æ—¥èªŒè¿½è¹¤
âœ… åœ¨æ‰€æœ‰éŒ¯èª¤æƒ…æ³ä¸‹éƒ½èƒ½æ­£ç¢ºæ¸…ç†

é€™å€‹è§£æ±ºæ–¹æ¡ˆç¢ºä¿åœ¨ä»»ä½•æƒ…æ³ä¸‹ï¼Œç³»çµ±ä¸­æœ€å¤šåªæœ‰ä¸€å€‹ Audio.Sound å¯¦ä¾‹å­˜åœ¨ã€‚

