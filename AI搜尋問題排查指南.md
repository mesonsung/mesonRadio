# 🔍 AI 搜尋問題排查指南

## 📋 已修復的問題

### 1. ✅ Gemini 模型名稱錯誤
- **問題**：使用了不存在的 `gemini-2.5-flash` 模型
- **修復**：改用正確的 `gemini-1.5-flash` 模型

### 2. ✅ 缺乏降級策略
- **問題**：AI 失敗後沒有好的備用方案
- **修復**：添加了三層降級策略：
  - 層級 1：AI 推薦
  - 層級 2：智能關鍵詞搜尋
  - 層級 3：原始查詢直接搜尋

### 3. ✅ AI 提示詞優化
- **問題**：AI 可能推薦不常見的電台
- **修復**：
  - 限制推薦 3-5 個電台（提高質量）
  - 提供知名電台列表作為參考
  - 要求使用簡短、常用的電台名稱

### 4. ✅ 添加詳細日誌
- **問題**：無法知道哪一步失敗
- **修復**：添加了完整的調試日誌，可以追蹤整個搜尋流程

## 🔧 如何測試修復

### 步驟 1：查看日誌
使用 `adb logcat` 查看詳細日誌：

```bash
adb logcat | grep -E "🔍|✅|⚠️|❌"
```

你會看到類似以下的日誌：

```
🔍 開始 AI 搜尋：我想聽新聞
✅ AI 推薦了 3 個電台
  🔎 搜尋推薦電台: BBC
    ✅ 找到 25 個電台
  🔎 搜尋推薦電台: NPR
    ✅ 找到 15 個電台
🎉 成功找到 2 個電台
```

### 步驟 2：測試不同查詢

#### 測試 1：簡單查詢
- 輸入：「新聞」
- 預期：應該找到 BBC、NPR 等新聞電台

#### 測試 2：音樂類型
- 輸入：「古典音樂」
- 預期：應該找到 Classical FM、BBC Radio 3 等

#### 測試 3：特定電台
- 輸入：「BBC」
- 預期：應該找到各種 BBC 電台

## ⚙️ 降級策略說明

### 流程圖

```
用戶查詢
    ↓
┌─────────────────┐
│ AI 推薦電台名稱  │ ← 主策略
└─────────────────┘
    ↓ 失敗
┌─────────────────┐
│ 智能關鍵詞搜尋   │ ← 降級策略 1
└─────────────────┘
    ↓ 失敗
┌─────────────────┐
│ 原始查詢直接搜尋 │ ← 降級策略 2
└─────────────────┘
    ↓
返回結果（或空）
```

### 降級策略 1：智能關鍵詞

如果 AI 無法推薦，系統會自動提取關鍵詞：

| 用戶輸入 | 提取關鍵詞 |
|---------|-----------|
| 我想聽新聞 | news, bbc, npr, cnn |
| 播放古典音樂 | classical, classic fm |
| 來點爵士樂 | jazz, smooth jazz |
| 搖滾電台 | rock, classic rock |

### 降級策略 2：直接搜尋

如果關鍵詞搜尋也失敗，直接用用戶的原始輸入查詢 Radio Browser API。

## 🐛 常見問題

### 問題 1：AI 回應「API Key 未配置」

**原因**：沒有設置 AI API Key

**解決方法**：
1. 進入「設定」→「AI 設定」
2. 選擇 AI 提供商（Gemini/ChatGPT/Grok）
3. 輸入 API Key
4. 保存

### 問題 2：搜尋後沒有結果

**可能原因 1**：AI API 調用失敗

查看日誌：
```bash
adb logcat | grep "Gemini API"
```

如果看到錯誤，檢查：
- API Key 是否正確
- 網路連接是否正常
- API 配額是否用完

**可能原因 2**：推薦的電台不存在

查看日誌：
```bash
adb logcat | grep "找不到電台"
```

這種情況下會自動降級到關鍵詞搜尋。

**可能原因 3**：Radio Browser API 問題

查看日誌：
```bash
adb logcat | grep "Radio Browser"
```

如果 API 無法訪問，檢查網路連接。

### 問題 3：只找到很少的電台

**原因**：AI 推薦的電台名稱不準確

**解決方法**：
1. 使用更具體的查詢（例如：「BBC 新聞」而不是「新聞」）
2. 如果持續問題，可能需要調整 AI 提示詞

## 📊 性能優化

### 搜尋速度優化

1. **選擇最佳電台**：
   - 按播放量（votes）排序
   - 選擇最受歡迎的電台（更可能可用）

2. **並行搜尋**：
   - 同時搜尋多個 AI 推薦的電台
   - 使用 Promise.all 加速

3. **結果限制**：
   - AI 推薦 3-5 個電台（避免過多）
   - 最終返回最多 10 個電台

## 🎯 最佳實踐

### 推薦的搜尋方式

#### ✅ 好的查詢
- 「新聞電台」
- 「古典音樂」
- 「爵士樂」
- 「BBC」
- 「NPR 新聞」

#### ❌ 不推薦的查詢
- 過於籠統：「電台」
- 過於具體：「2024年1月1日的新聞電台」
- 不相關：「天氣預報」

### 提升搜尋成功率的技巧

1. **使用類型關鍵詞**：
   - 新聞、音樂、古典、爵士、搖滾等

2. **指定知名電台**：
   - BBC、NPR、KCRW 等

3. **結合國家/語言**：
   - 「英國新聞」
   - 「美國爵士」

## 🔄 未來改進方向

### 1. 本地電台緩存
- 緩存常用電台
- 減少 API 調用

### 2. 用戶偏好學習
- 記錄用戶常聽的電台
- AI 優先推薦類似電台

### 3. 多語言支持
- 支持更多語言的查詢
- 自動翻譯電台名稱

## 📞 仍然無法解決？

如果按照以上步驟仍無法解決：

1. **收集日誌**：
   ```bash
   adb logcat > search_log.txt
   ```

2. **記錄以下信息**：
   - 使用的 AI 提供商
   - 搜尋的關鍵詞
   - 錯誤訊息
   - 日誌片段

3. **檢查配置**：
   - API Key 是否有效
   - 網路連接是否正常
   - 應用版本是否最新

## 🎉 修復總結

經過這次優化，AI 搜尋功能現在：

1. ✅ 使用正確的 Gemini 模型
2. ✅ 有三層降級保護
3. ✅ 優化了 AI 提示詞
4. ✅ 添加了詳細日誌
5. ✅ 選擇最佳電台
6. ✅ 智能關鍵詞提取

**即使 AI 完全失敗，也能通過關鍵詞或直接搜尋找到電台！**

