# 小米澎湃OS（HyperOS）& MIUI 背景播放設定指南 🔧
# HyperOS & MIUI Background Playback Setup Guide

## ⚠️ 重要提示

小米的 **澎湃OS（HyperOS）** 和 **MIUI** 系統對背景應用限制**非常嚴格**！

如果不正確設定，即使有前台服務和通知，播放仍會被殺掉。

**必須完成以下所有設定才能正常背景播放！**

---

## 🆕 您使用的是哪個系統？

### 澎湃OS（HyperOS）- 2023年底後發布
- 小米 14 系列及之後機型
- 從 MIUI 14 升級到澎湃OS 的機型
- 設定界面更現代化

### MIUI - 傳統系統
- 小米 13 系列及之前機型
- 未升級澎湃OS 的舊機型

**兩個系統的設定方式基本相同，但位置略有差異。**

---

## 🎯 必須完成的 5 個設定

---

### 📍 設定 1：關閉電池優化（最重要！）⭐

#### 🆕 澎湃OS（HyperOS）路徑：

**路徑 A（推薦）**：設定 → 應用 → 應用管理 → mesonRadio → 電池使用 → 無限制

**路徑 B**：設定 → 搜尋「電池優化」→ mesonRadio → 無限制

#### MIUI 路徑：

**路徑**：設定 → 應用設定 → 應用管理 → mesonRadio → 省電策略

**澎湃OS 步驟**：
1. 打開 **設定**
2. 進入 **應用** 或 **應用管理**
3. 找到並點擊 **mesonRadio**
4. 點擊 **電池使用** 或 **省電策略**
5. 選擇 **✅ 無限制**（關鍵！）

**MIUI 步驟**：
1. 打開 **設定**
2. 進入 **應用設定**
3. 選擇 **應用管理**
4. 找到並點擊 **mesonRadio**
5. 點擊 **省電策略**
6. 選擇 **✅ 無限制**（關鍵！）

**選項說明**：
```
○ 智能限制    ← 不要選！會被系統殺掉
● 無限制      ← 選這個！⭐ 
○ 省電        ← 不要選！會被限制
```

---

### 📍 設定 2：允許自啟動

#### 🆕 澎湃OS（HyperOS）：

**路徑**：設定 → 應用 → 應用管理 → mesonRadio → 自啟動

**新功能**：澎湃OS 可能顯示為「後台自啟動」或「應用行為控制」

#### MIUI：

**路徑**：設定 → 應用設定 → 應用管理 → mesonRadio → 自啟動

**步驟**：
1. 在 mesonRadio 應用詳情頁
2. 找到 **自啟動** 或 **後台自啟動**
3. 打開開關 **✅ 允許自啟動**

**為什麼需要**：
- 允許應用在系統重啟後自動恢復
- 防止被系統清理後無法重啟
- 澎湃OS 特別重視此設定

---

### 📍 設定 3：允許後台彈出界面

**路徑**：設定 → 應用設定 → 應用管理 → mesonRadio → 後台彈出界面

**步驟**：
1. 在 mesonRadio 應用詳情頁
2. 找到 **後台彈出界面**
3. 打開開關 **✅ 允許**

**為什麼需要**：
- 允許前台服務通知正常顯示
- 防止通知被阻止

---

### 📍 設定 4：關閉鎖屏清理

**路徑**：設定 → 應用設定 → 應用管理 → mesonRadio → 鎖屏清理

**步驟**：
1. 在 mesonRadio 應用詳情頁
2. 找到 **鎖屏清理**
3. 關閉開關 **❌ 不允許清理**

**為什麼需要**：
- 防止鎖屏後應用被清理
- 保持播放不中斷

---

### 📍 設定 5：授予通知權限

**路徑**：設定 → 應用設定 → 應用管理 → mesonRadio → 通知管理

**步驟**：
1. 在 mesonRadio 應用詳情頁
2. 點擊 **通知管理**
3. 打開 **✅ 允許通知**
4. 確保 **背景播放** 頻道已啟用

---

## 📋 完整設定檢查清單

在 mesonRadio 應用詳情頁，確認：

```
mesonRadio 應用詳情
├─ ✅ 省電策略：無限制
├─ ✅ 自啟動：已開啟
├─ ✅ 後台彈出界面：已允許
├─ ✅ 鎖屏清理：已關閉
└─ ✅ 通知管理：已允許
```

**所有項目都必須正確設定！**

---

## 🔍 快速檢查方法

### 方法 1：視覺檢查

打開 **設定** → **應用設定** → **應用管理** → **mesonRadio**

在應用詳情頁面，您應該看到：
- 省電策略顯示 **無限制**
- 自啟動開關為 **綠色/開啟**
- 後台彈出界面為 **綠色/開啟**

### 方法 2：使用 ADB 命令檢查

```bash
# 檢查省電策略
adb shell dumpsys deviceidle whitelist | grep mesonradio

# 檢查自啟動
adb shell dumpsys package com.meson.mesonradio | grep "autostart"

# 檢查通知權限
adb shell dumpsys notification | grep mesonradio
```

---

## 🧪 測試流程

### 完整測試步驟：

```bash
# 1. 安裝最新版本
adb install -r android/app/build/outputs/apk/release/app-release.apk

# 2. 完成上述所有 5 個設定

# 3. 啟動應用並播放電台

# 4. 監控日誌
adb logcat | grep -E "前台服務|Foreground|健康檢查|Playing"

# 5. 鎖屏測試
#    - 按電源鍵鎖屏
#    - 等待 10 分鐘
#    - 解鎖
#    - 音樂應該還在播放！
```

### 預期結果：

✅ 通知欄顯示 "🎵 電台名稱"  
✅ 鎖屏後音樂繼續播放  
✅ 10 分鐘後音樂仍在播放  
✅ 日誌每 30 秒顯示健康檢查  

---

## ❌ 常見問題（MIUI 特定）

### 問題 1：設定後還是被殺掉

**可能原因**：
1. 沒有完成所有 5 個設定
2. MIUI 版本過舊或過新（行為可能不同）
3. 第三方清理工具干擾

**解決方案**：
```bash
# 檢查是否真的在白名單中
adb shell dumpsys deviceidle whitelist

# 手動添加到白名單（需要 root 或開發者權限）
adb shell dumpsys deviceidle whitelist +com.meson.mesonradio
```

---

### 問題 2：通知不顯示

**MIUI 12+ 特殊設定**：

1. **設定** → **通知和控制中心**
2. **通知排序方式** → 選擇 **按時間排序**
3. **常駐通知** → 找到 mesonRadio，允許常駐

---

### 問題 3：鎖屏後立即停止

**檢查「鎖屏清理」設定**：

**設定** → **鎖屏和密碼** → **鎖屏進階設定**
- 關閉 **鎖屏後清理記憶體**

或者：

**設定** → **電池與效能** → **省電優化**
- mesonRadio 設為 **無限制**

---

### 問題 4：神隱模式干擾

MIUI 有個「神隱模式」會干擾背景應用：

**路徑**：設定 → 電池與效能 → 省電優化 → 應用智能省電

**步驟**：
1. 找到 **應用智能省電**
2. 找到 **mesonRadio**
3. 選擇 **✅ 無限制**

---

## 🔧 系統版本差異

### 🆕 澎湃OS（HyperOS）1.0/2.0：
```
設定 → 應用 → 應用管理 → mesonRadio
  ├─ 電池使用 → 無限制 ⭐
  ├─ 後台自啟動 → 開啟
  ├─ 後台彈出界面 → 允許
  └─ 通知管理 → 允許
```

**澎湃OS 特點**：
- 界面更簡潔
- 設定項可能合併或重新命名
- 「鎖屏清理」可能整合到「電池使用」中
- 背景限制比 MIUI 略為寬鬆（但仍需設定！）

---

### MIUI 版本：

#### MIUI 11 及更早：
- 設定 → 電池和效能 → 管理應用的電池使用情況

#### MIUI 12/12.5：
- 設定 → 應用設定 → 應用管理 → 省電策略

#### MIUI 13：
- 設定 → 應用 → 應用管理 → 省電策略
- 增加了更嚴格的限制

#### MIUI 14/15：
- 設定 → 應用 → 管理應用 → 電池使用
- 省電策略位置可能不同

---

**提示**：如果找不到設定，在設定中搜尋 "省電"、"後台" 或 "電池優化"

---

## 🎯 MIUI 優化總結

### 必須設定（5項）：

| 設定項目 | 位置 | 設定值 |
|---------|------|--------|
| 省電策略 | 應用管理 → mesonRadio | 無限制 |
| 自啟動 | 應用管理 → mesonRadio | 開啟 |
| 後台彈出界面 | 應用管理 → mesonRadio | 允許 |
| 鎖屏清理 | 應用管理 → mesonRadio | 關閉 |
| 通知權限 | 應用管理 → mesonRadio | 允許 |

### 推薦設定（可選）：

| 設定項目 | 位置 | 設定值 |
|---------|------|--------|
| 鎖屏後清理記憶體 | 鎖屏和密碼 → 進階設定 | 關閉 |
| 神隱模式 | 電池與效能 | mesonRadio 設為無限制 |
| 通知排序 | 通知和控制中心 | 按時間排序 |

---

## 📱 快速設定路徑（MIUI 13/14）

### 最快設定方式：

1. **打開設定 App**
2. **上方搜尋框輸入**：mesonRadio
3. **點擊搜尋結果** → 進入應用詳情
4. **逐一檢查並設定**：
   - 省電策略 → 無限制
   - 自啟動 → 開啟
   - 後台彈出界面 → 允許
   - 鎖屏清理 → 關閉
   - 通知管理 → 允許

---

## 🆘 仍然無法背景播放？

如果完成所有設定後仍有問題：

### 診斷步驟：

```bash
# 1. 運行診斷腳本
./diagnose-background.sh

# 2. 檢查 MIUI 限制
adb shell dumpsys power | grep mesonradio
adb shell dumpsys battery | grep optimization

# 3. 查看完整日誌
adb logcat > miui-full-log.txt
# 播放電台、鎖屏、等待 5 分鐘後停止
```

### 提供以下信息：

1. **MIUI 版本**：設定 → 我的裝置 → MIUI 版本
2. **Android 版本**：設定 → 我的裝置 → Android 版本
3. **診斷結果**：診斷腳本的輸出
4. **日誌文件**：miui-full-log.txt

---

## 💡 MIUI 特別提示

### 提示 1：每次系統更新後重新檢查

MIUI 系統更新後，某些設定可能被重置，需要重新設定。

### 提示 2：避免使用系統清理功能

MIUI 內建的「清理加速」可能會殺掉背景應用，建議：
- 不要使用「一鍵清理」
- 或在清理時保護 mesonRadio

### 提示 3：關閉「超級省電模式」

超級省電模式會強制清理所有背景應用：
- 設定 → 電池與效能 → 省電模式
- 不要開啟超級省電

---

## ✅ 成功案例

完成設定後，您應該能夠：

✅ 鎖屏後連續播放 1 小時以上  
✅ 切換到其他 App 時繼續播放  
✅ 網路切換後自動恢復播放  
✅ 通知欄持續顯示播放狀態  
✅ 手機待機時持續播放  

---

## 📞 獲取幫助

如果完成所有設定後仍有問題，請提供：

```bash
# 系統信息
adb shell getprop ro.miui.ui.version.name  # MIUI 版本
adb shell getprop ro.build.version.release # Android 版本

# 應用狀態
adb shell dumpsys deviceidle whitelist | grep mesonradio
adb shell dumpsys package com.meson.mesonradio | grep -A 5 "permissions"

# 運行日誌
adb logcat -d > miui-issue.log
```

---

**更新日期**：2025-10-08  
**版本**：v1.0.5 - MIUI 優化版  
**適用於**：MIUI 11/12/13/14/15

🎵 **祝您在小米手機上享受完美的背景播放體驗！**
